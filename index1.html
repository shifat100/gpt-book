<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Library & Flipbook</title>
    
    <!-- লাইব্রেরি (ইন্টারনেট কানেকশন প্রয়োজন) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- গুগল ফন্ট -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- বেসিক সেটআপ --- */
        body { margin: 0; padding: 0; background: #f4f4f4; font-family: 'Crimson Text', serif; overflow: hidden; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* --- ১. হোম স্ক্রিন (বইয়ের তালিকা) --- */
        #home-view {
            width: 100%; height: 100vh; overflow-y: auto;
            padding: 40px 20px; text-align: center;
            background: #eaddcf; /* ভিন্টেজ ব্যাকগ্রাউন্ড */
        }
        
        .library-header { font-size: 2.5rem; color: #4a192c; margin-bottom: 30px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px; max-width: 1000px; margin: 0 auto;
        }

        /* বইয়ের কার্ড ডিজাইন */
        .book-card {
            background: #4a192c; color: #d4af37;
            border-radius: 5px; cursor: pointer;
            height: 280px; position: relative;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border-left: 10px solid #2c0e1a; /* বইয়ের স্পাইন */
            padding: 20px;
        }
        .book-card:hover { transform: translateY(-10px) scale(1.02); }
        .book-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 10px; line-height: 1.2; }
        .book-info { font-size: 0.9rem; opacity: 0.8; font-family: 'Lato', sans-serif; }

        /* --- ২. রিডার স্ক্রিন (ফ্লিপবুক) --- */
        #reader-view {
            display: none; /* শুরুতে লুকানো থাকবে */
            width: 100%; height: 100vh;
            background: #333;
            justify-content: center; align-items: center;
            flex-direction: column;
            position: relative;
        }

        /* ফ্লিপবুক কন্টেইনার */
        #flipbook { width: 800px; height: 500px; transition: margin 0.3s; }
        
        .page {
            background-color: #fdf6e3; color: #333;
            box-shadow: inset -5px 0 20px rgba(0,0,0,0.05);
            font-size: 18px; line-height: 1.6; text-align: justify;
        }
        .page-content { padding: 40px; height: 100%; overflow: hidden; border: 1px solid #ddd; }
        
        /* কভার পেজ স্টাইল */
        .page.hard {
            background: #4a192c !important; color: #d4af37 !important;
            border: 5px double #d4af37; display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        /* --- কন্ট্রোল বাটনস --- */
        .back-btn {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(255,255,255,0.2); color: #fff; border: 1px solid #fff;
            padding: 8px 15px; border-radius: 30px; cursor: pointer;
            display: flex; align-items: center; gap: 5px; font-family: 'Lato', sans-serif;
        }
        .back-btn:hover { background: #fff; color: #333; }

        .nav-controls {
            position: absolute; bottom: 20px; z-index: 1000;
            display: flex; gap: 20px;
        }
        .nav-btn {
            background: #fff; border: none; padding: 10px; border-radius: 50%;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* --- মোবাইল রেসপন্সিভ --- */
        @media (max-width: 768px) {
            #flipbook { width: 90vw; height: 75vh; }
            .page-content { padding: 25px; font-size: 16px; }
            .library-header { font-size: 1.8rem; }
        }

        /* লোডার */
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: #fff; display: none; justify-content: center; align-items: center; z-index: 2000; }
    </style>
</head>
<body>

    <!-- লোডার -->
    <div class="loader" id="loader">লোড হচ্ছে...</div>

    <!-- ১. হোম ভিউ (বইয়ের তালিকা) -->
    <div id="home-view">
        <div class="library-header">MY LIBRARY</div>
        <div class="book-grid" id="book-list">
            <!-- জাভাস্ক্রিপ্ট দিয়ে বই এখানে আসবে -->
        </div>
    </div>

    <!-- ২. রিডার ভিউ (ফ্লিপবুক) -->
    <div id="reader-view">
        <button class="back-btn" onclick="goHome()">
            <span class="material-icons">arrow_back</span> Back to Library
        </button>

        <div id="flipbook"></div>

        <div class="nav-controls">
            <button class="nav-btn" onclick="$('#flipbook').turn('previous')"><span class="material-icons">west</span></button>
            <button class="nav-btn" onclick="$('#flipbook').turn('next')"><span class="material-icons">east</span></button>
        </div>
    </div>

    
            // আগের বই থাকলে ডিলিট করা (Destroy)
            if (flipbook.turn('is')) {
                flipbook.turn('destroy');
                $(window).unbind('keydown'); // ইভেন্ট রিমুভ
            }
            
            flipbook.html(''); // HTML ক্লিয়ার

            // ১. কভার পেজ যোগ
            flipbook.append(`
                <div class="page hard">
                    <h1 style="font-size: 2rem; margin:0;">${title}</h1>
                    <p>Tap to read</p>
                </div>
                <div class="page hard"></div>
                            <script>
        let allBooks = [];

        $(document).ready(function() {
            // ১. ডাটাবেজ থেকে বই আনা
            $.getJSON('books/db.json', function(data) {
                allBooks = data;
                renderBookList(data);
            }).fail(function() {
                console.log("JSON not found, loading dummy data");
                allBooks = [
                    { id: "1", title: "Demo Book One", chapters: [{file: "sample.md", title: "Chapter 1"}] },
                    { id: "2", title: "The Jungle Book", chapters: [{file: "sample.md", title: "Start"}] },
                    { id: "3", title: "Physics 101", chapters: [{file: "sample.md", title: "Intro"}] }
                ];
                renderBookList(allBooks);
            });
        });

        function renderBookList(books) {
            const list = $('#book-list');
            list.empty();
            books.forEach(book => {
                const html = `
                    <div class="book-card" onclick="openBook('${book.id}')">
                        <div class="book-title">${book.title}</div>
                        <div class="book-info">${book.chapters.length} Chapters</div>
                        <div style="margin-top:auto; font-size:2rem;">❦</div>
                    </div>
                `;
                list.append(html);
            });
        }

        function openBook(bookId) {
            const book = allBooks.find(b => b.id === bookId);
            if (!book) return;

            $('#loader').css('display', 'flex');
            
            const chapter = book.chapters[0];
            const filePath = book.folder ? `${book.folder}/${chapter.file}` : chapter.file;

            fetch(filePath)
                .then(res => {
                    if(!res.ok) throw new Error("File not found");
                    return res.text();
                })
                .then(text => {
                    // সমাধান ১: আগে ভিউ শো করতে হবে, তারপর ফ্লিপবুক বানাতে হবে
                    $('#home-view').hide();
                    $('#reader-view').css('display', 'flex');
                    
                    // ভিউ শো হওয়ার পর একটু সময় দিয়ে বই লোড করা ভালো (রেন্ডারিং এর জন্য)
                    setTimeout(() => {
                        setupFlipbook(book.title, marked.parse(text));
                        $('#loader').hide();
                    }, 100);
                })
                .catch(err => {
                    const dummy = `<h1>${book.title}</h1><p>দুঃখিত, ফাইলটি লোড করা যায়নি। ডামি টেক্সট।</p>` + 
                                  `<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</p>`.repeat(10);
                    
                    $('#home-view').hide();
                    $('#reader-view').css('display', 'flex');
                    
                    setTimeout(() => {
                        setupFlipbook(book.title, dummy);
                        $('#loader').hide();
                    }, 100);
                });
        }

        function setupFlipbook(title, htmlContent) {
            const flipbook = $('#flipbook');
            
            // সমাধান ২: .turn('is') বাদ দিয়ে ক্লাসিক পদ্ধতিতে চেক করা
            // যদি আগে কোনো turn ইনস্ট্যান্স থাকে, তবে সেটা ডিলিট করা
            try {
                // v3 তে data().turn চেক করা নিরাপদ অথবা সরাসরি destroy কল করা (try-catch সহ)
                if (flipbook.data().turn) {
                    flipbook.turn('destroy');
                    $(window).unbind('keydown');
                }
            } catch(e) {
                console.log("Resetting flipbook...");
            }
            
            // HTML ক্লিয়ার এবং নতুন করে সেট
            flipbook.html('').attr('style', ''); // style রিসেট করা জরুরি

            // ১. কভার পেজ
            flipbook.append(`
                <div class="page hard">
                    <h1 style="font-size: 2rem; margin:0;">${title}</h1>
                    <p>Tap to read</p>
                </div>
                <div class="page hard"></div>
            `);

            // ২. কনটেন্ট প্রসেসিং
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlContent, 'text/html');
            const elements = Array.from(doc.body.children);

            let pageContent = '';
            let charLimit = $(window).width() < 768 ? 400 : 800; 
            let currentCount = 0;

            elements.forEach(el => {
                const textLen = el.textContent.length;
                if (currentCount + textLen > charLimit || el.tagName === 'IMG') {
                    if (pageContent) addPage(flipbook, pageContent);
                    pageContent = '';
                    currentCount = 0;
                }
                pageContent += el.outerHTML;
                currentCount += textLen;
            });
            if(pageContent) addPage(flipbook, pageContent);

            // ৩. শেষ পেজ
            flipbook.append('<div class="page hard"></div><div class="page hard">THE END</div>');

            // ৪. Turn.js চালু করা
            initTurnJs();
        }

        function addPage(container, content) {
            container.append(`<div class="page"><div class="page-content">${content}</div></div>`);
        }

        function initTurnJs() {
            const isMobile = $(window).width() < 768;
            const flipbook = $('#flipbook');

            flipbook.turn({
                width: isMobile ? $(window).width() * 0.9 : 800,
                height: isMobile ? $(window).height() * 0.6 : 500,
                autoCenter: true,
                display: isMobile ? 'single' : 'double',
                duration: 1000,
                gradients: true,
                elevation: 50
            });

            $(window).bind('keydown', function(e) {
                if (e.keyCode == 37) flipbook.turn('previous');
                if (e.keyCode == 39) flipbook.turn('next');
            });
        }

        function goHome() {
            $('#reader-view').hide();
            $('#home-view').show();
            
            // ক্লিনআপ
            const flipbook = $('#flipbook');
            try {
                if (flipbook.data().turn) {
                    flipbook.turn('destroy');
                }
            } catch(e) {}
            flipbook.html('');
        }

        $(window).resize(function() {
            // রিসাইজ লজিক: শুধু যদি ভিউ ওপেন থাকে
            if ($('#reader-view').is(':visible')) {
                const flipbook = $('#flipbook');
                // v3 তে data().turn চেক করা ভালো
                if (flipbook.data() && flipbook.data().turn) {
                    flipbook.turn('resize');
                }
            }
        });
                </script>
</body>
          </html>
