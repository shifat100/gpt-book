<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPT E-Book Library</title>
    <meta name="theme-color" id="theme-color" content="#4285f4" />

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">
    
    <!-- React Libraries -->
    <script crossorigin src="react.development.js"></script>
    <script crossorigin src="react-dom.development.js"></script>
    <script src="babel.min.js"></script>
    <script src="marked.min.js"></script>

    <!-- KaTeX JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- গ্লোবাল স্টাইল --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-body: #e0e0e0;      
            --bg-paper: #ffffff;     
            --text-main: #1a1a1a;    
            --border-color: #000;    
            --accent: #8b0000;
            --highlight: #ffeeba;       
            --shadow: 0 5px 20px rgba(0,0,0,0.15);
            --safe-bottom: 80px; 
            --sidebar-width: 280px;
        }

        body.theme-white { --bg-body: #f0f2f5; --bg-paper: #ffffff; --text-main: #2c2c2c; --border-color: #ddd; }
        body.theme-sepia { --bg-body: #f4ecd8; --bg-paper: #fdf6e3; --text-main: #5b4636; --border-color: #d3c0a5; --accent: #a0522d; --highlight: #ffdfba; }
        body.theme-black { --bg-body: #121212; --bg-paper: #1e1e1e; --text-main: #d1d1d1; --border-color: #444; --accent: #ff6b6b; --shadow: 0 5px 20px rgba(0,0,0,0.5); --highlight: #4a4a4a; }

        html { width: 100%; height: 100%; overflow: hidden; }
        body { 
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-body); color: var(--text-main); 
            font-family: 'Crimson Text', serif;
        }

        .app-container { display: flex; flex-direction: column; width: 100%; height: 100vh; height: 100dvh; overflow: hidden; }
        
        /* Sidebar (Desktop Only) */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-paper);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            display: none;
            flex-direction: column;
            z-index: 100;
            height: 100%;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); font-weight: bold; font-family: 'Lato', sans-serif; color: var(--accent); }
        .sidebar-item { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); font-size: 15px; transition: 0.2s; }
        .sidebar-item:hover { background: rgba(0,0,0,0.05); }
        .sidebar-item.active { background: var(--accent); color: #fff; }

        /* SCROLL MODE STYLES */
        .scroll-mode-wrapper { display: flex; flex: 1; overflow: hidden; width: 100%; max-width: 1400px; margin: 0 auto; }
        .scroll-reader-area { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; display: flex; justify-content: center; position: relative; }
        
        @media (min-width: 992px) { .sidebar { display: flex; } }

        .book-sheet {
            background-color: var(--bg-paper); color: var(--text-main);
            width: 100%; max-width: 800px; min-height: 100%; height: fit-content;
            padding: 60px 50px; padding-bottom: 100px;
            box-shadow: var(--shadow); border-radius: 4px;
        }

        /* --- FLIPBOOK / PAGINATED MODE STYLES (New) --- */
        .flip-wrapper {
            flex: 1; width: 100%; height: 100%; 
            display: flex; justify-content: center; align-items: center; 
            overflow: hidden; perspective: 1000px;
            position: relative;
        }
        
        /* The Pagination Container using CSS Columns */
        .paginated-container {
            width: 100%; height: 100%;
            padding: 40px 20px; /* Padding creates margins */
            padding-bottom: 80px;
            column-width: 100vw; /* Trick to force one page per screen width */
            column-gap: 40px;
            column-fill: auto;
            height: calc(100vh - 80px); /* Adjust based on header/footer */
            overflow-y: hidden; /* Hide vertical scroll */
            overflow-x: hidden; /* We manage horizontal scroll manually */
            
            /* Positioning for the slide effect */
            transform: translateX(0);
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.3s;
        }

        /* Adjust content for pagination */
        .paginated-content {
            font-size: 1.1em;
            text-align: justify;
        }
        .paginated-content p, .paginated-content h1, .paginated-content h2, .paginated-content img, .paginated-content pre {
            break-inside: avoid; /* Prevent splitting elements across columns */
            page-break-inside: avoid;
            max-width: 100%;
        }
        .paginated-content img { max-height: 80vh; width: auto; display: block; margin: 0 auto; }

        /* Animation classes */
        .page-turning { opacity: 0.5; transform-origin: left center; transform: rotateY(-10deg); }

        /* Footer in Flip Mode */
        .flip-footer {
            position: absolute; bottom: 15px; width: 100%; text-align: center;
            font-size: 12px; opacity: 0.6; z-index: 200; pointer-events: none;
            font-family: 'Lato', sans-serif;
        }

        /* Click Zones for Desktop */
        .click-zone { position: absolute; top: 0; bottom: 60px; width: 15%; z-index: 50; cursor: pointer; }
        .zone-prev { left: 0; }
        .zone-next { right: 0; }
        .zone-prev:hover { background: linear-gradient(to right, rgba(0,0,0,0.05), transparent); }
        .zone-next:hover { background: linear-gradient(to left, rgba(0,0,0,0.05), transparent); }

        /* --- Shared Styles --- */
        .controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--bg-paper); padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; gap: 12px; z-index: 1000;
            border: 1px solid var(--border-color); align-items: center;
            max-width: 95%; overflow-x: auto;
        }
        .btn { background: none; border: none; cursor: pointer; color: var(--text-main); padding: 8px; border-radius: 50%; min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center; }
        .btn:hover { background: rgba(0,0,0,0.08); }
        .btn.active-mode { background: var(--accent); color: white; }
        .v-sep { width: 1px; height: 24px; background: var(--text-main); opacity: 0.2; }
        .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 30px; border-radius: 30px; z-index: 3000; }
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 12px 24px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 5000; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(10px); }

        /* Index Page for Flip Mode */
        .flip-index-page {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; text-align: center; padding: 20px; overflow-y: auto;
        }
        .index-list { width: 100%; max-width: 500px; text-align: left; margin-top: 20px; max-height: 60vh; overflow-y: auto; }
        .index-item { padding: 15px; border-bottom: 1px dashed var(--border-color); cursor: pointer; }
        .index-item:hover { color: var(--accent); background: rgba(0,0,0,0.05); }

        /* Common Markdown Styles */
        .markdown-body { line-height: 1.6; }
        .markdown-body h1 { text-align: center; margin-top: 0; text-transform: uppercase; }
        .katex { font-size: 1.1em; color: var(--text-main); }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 0.85em; }
        table th { background: var(--accent); color: #fff; padding: 8px; }
        table td { border-bottom: 1px solid rgba(0,0,0,0.1); padding: 8px; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; border-radius: 4px; }
        
        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .paginated-container { padding: 30px 15px; column-gap: 30px; }
            .book-sheet { padding: 30px 20px; padding-bottom: 100px; border-radius: 0; box-shadow: none; }
            .click-zone { display: none; } /* Mobile uses swipe only */
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // --- Markdown & KaTeX Component ---
        const MarkdownViewer = ({ content, fontSize, className }) => {
            const rootRef = useRef();
            const html = marked.parse(content || '');
            useEffect(() => {
                if (rootRef.current && window.renderMathInElement) {
                    window.renderMathInElement(rootRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ], throwOnError: false
                    });
                }
            }, [content]);
            return <div ref={rootRef} className={`markdown-body ${className || ''}`} style={{ fontSize: `${fontSize}px` }} dangerouslySetInnerHTML={{ __html: html }} />;
        };

        function App() {
            // Data & View State
            const [books, setBooks] = useState([]);
            const [activeBook, setActiveBook] = useState(null);
            const [activeChapter, setActiveChapter] = useState(null);
            const [mdContent, setMdContent] = useState('');
            const [viewMode, setViewMode] = useState('home'); // home, read
            const [readingSystem, setReadingSystem] = useState('scroll'); // scroll, flip
            
            // Settings
            const [theme, setTheme] = useState('white');
            const [fontSize, setFontSize] = useState(19);
            const [loading, setLoading] = useState(false);
            const [toastMsg, setToastMsg] = useState('');

            // Search (Simplified for this snippet)
            const [showSearch, setShowSearch] = useState(false);

            // --- Flip Mode Specific States ---
            const [flipCurrentPage, setFlipCurrentPage] = useState(0); // 0 = start of chapter
            const [flipTotalPages, setFlipTotalPages] = useState(1);
            const contentRef = useRef(null); // Reference to the paginated column container
            const [isIndexPage, setIsIndexPage] = useState(false); // True if showing Book Index in flip mode

            // Initial Load
            useEffect(() => {
                fetch('books/db.json').then(res => res.json()).then(data => { setBooks(data); });
            }, []);

            useEffect(() => {
                document.body.className = `theme-${theme}`;
                const meta = document.getElementById("theme-color");
                if (meta) meta.setAttribute("content", theme);
            }, [theme]);

            // --- Navigation Logic ---
            const loadChapter = async (book, chapter) => {
                setLoading(true);
                setActiveBook(book);
                setActiveChapter(chapter);
                try {
                    const res = await fetch(`${book.folder}/${chapter.file}`);
                    const text = await res.text();
                    setMdContent(text);
                    setLoading(false);
                    // Reset positions
                    if (readingSystem === 'scroll') {
                        const reader = document.getElementById('scroll-reader');
                        if(reader) reader.scrollTop = 0;
                    } else {
                        setFlipCurrentPage(0); // Start at page 1 (index 0) of the new chapter
                    }
                } catch(e) {
                    setMdContent("# Error Loading Chapter");
                    setLoading(false);
                }
            };

            const toggleReadingSystem = () => {
                const newSystem = readingSystem === 'scroll' ? 'flip' : 'scroll';
                setReadingSystem(newSystem);
                if (newSystem === 'flip') {
                    // Go to Index page first when switching to Flip mode usually feels better
                    setIsIndexPage(true);
                } else {
                    // Switch back to scroll mode with current chapter
                    setIsIndexPage(false);
                }
            };

            // --- FLIP MODE LOGIC (The Core Request) ---
            
            // Calculate total pages when content or resize happens
            useLayoutEffect(() => {
                if (readingSystem === 'flip' && !isIndexPage && contentRef.current) {
                    const { scrollWidth, clientWidth } = contentRef.current;
                    // Total pages = Total scroll width / width of one "page" (screen)
                    const pages = Math.ceil(scrollWidth / (clientWidth + 40)); // 40 is approximate gap
                    setFlipTotalPages(Math.max(1, pages));
                }
            }, [mdContent, fontSize, readingSystem, isIndexPage, activeChapter]);

            // Handle Page Turn in Flip Mode
            const handleFlipTurn = (direction) => {
                if (direction === 'next') {
                    if (flipCurrentPage < flipTotalPages - 1) {
                        setFlipCurrentPage(p => p + 1);
                    } else {
                        // End of chapter, ask to go to next chapter
                        const idx = activeBook.chapters.findIndex(c => c.id === activeChapter.id);
                        if (idx < activeBook.chapters.length - 1) {
                            if(confirm("পরের অধ্যায়ে যাবেন?")) {
                                loadChapter(activeBook, activeBook.chapters[idx + 1]);
                            }
                        } else {
                            showToast("বই শেষ!");
                        }
                    }
                } else {
                    if (flipCurrentPage > 0) {
                        setFlipCurrentPage(p => p - 1);
                    } else {
                        // Ask to go to index or prev chapter
                        const idx = activeBook.chapters.findIndex(c => c.id === activeChapter.id);
                        if (idx > 0) {
                             if(confirm("আগের অধ্যায়ে যাবেন?")) {
                                loadChapter(activeBook, activeBook.chapters[idx - 1]);
                            }
                        } else {
                            setIsIndexPage(true); // Go back to TOC
                        }
                    }
                }
            };

            // Touch Handling for Swipe
            const touchStart = useRef(null);
            const handleTouchStart = (e) => { touchStart.current = e.touches[0].clientX; };
            const handleTouchEnd = (e) => {
                if (!touchStart.current) return;
                const touchEnd = e.changedTouches[0].clientX;
                const diff = touchStart.current - touchEnd;
                
                // Swipe Threshold (e.g., 50px)
                if (Math.abs(diff) > 50) {
                    if (diff > 0) handleFlipTurn('next'); // Swipe Left -> Next
                    else handleFlipTurn('prev'); // Swipe Right -> Prev
                }
                touchStart.current = null;
            };

            // --- COMPONENTS ---

            const Sidebar = () => (
                <div className="sidebar">
                    <div className="sidebar-header">{activeBook?.title}</div>
                    {activeBook?.chapters.map(c => (
                        <div key={c.id} className={`sidebar-item ${activeChapter?.id === c.id ? 'active' : ''}`}
                             onClick={() => {
                                 if(readingSystem==='flip') { setIsIndexPage(false); loadChapter(activeBook, c); }
                                 else loadChapter(activeBook, c);
                             }}>
                            {c.title}
                        </div>
                    ))}
                </div>
            );

            const FlipView = () => {
                if (isIndexPage) {
                    return (
                        <div className="flip-wrapper" style={{background: 'var(--bg-paper)'}}>
                            <div className="flip-index-page">
                                <h1 style={{color: 'var(--accent)'}}>{activeBook.title}</h1>
                                <p>সূচিপত্র</p>
                                <div className="index-list">
                                    {activeBook.chapters.map((c, i) => (
                                        <div key={c.id} className="index-item" onClick={() => { setIsIndexPage(false); loadChapter(activeBook, c); }}>
                                            {i + 1}. {c.title}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="flip-wrapper" 
                         onTouchStart={handleTouchStart} 
                         onTouchEnd={handleTouchEnd}>
                        
                        {/* Click Zones for Desktop */}
                        <div className="click-zone zone-prev" onClick={() => handleFlipTurn('prev')}></div>
                        <div className="click-zone zone-next" onClick={() => handleFlipTurn('next')}></div>

                        <div className="paginated-container" ref={contentRef}
                             style={{
                                 // Shift the container left by (Page Width * Current Page)
                                 transform: `translateX(calc(-100vw * ${flipCurrentPage} - ${flipCurrentPage * 40}px))`, 
                                 width: '100vw' 
                             }}>
                            <div className="paginated-content" style={{
                                columnWidth: 'calc(100vw - 40px)', // Force content into columns equal to screen width
                                height: '100%'
                            }}>
                                <h2 style={{textAlign:'center', borderBottom:'1px solid #ccc', paddingBottom:10}}>{activeChapter?.title}</h2>
                                <MarkdownViewer content={mdContent} fontSize={fontSize} />
                                <div style={{height:'100px'}}></div> {/* Spacer for last page */}
                            </div>
                        </div>

                        <div className="flip-footer">
                            Page {flipCurrentPage + 1} of {flipTotalPages}
                        </div>
                    </div>
                );
            };

            const ScrollView = () => (
                <div className="scroll-mode-wrapper">
                    <Sidebar />
                    <div className="scroll-reader-area" id="scroll-reader">
                        <div className="book-sheet">
                            <h4 style={{textAlign:'center', opacity:0.5}}>{activeBook?.title}</h4>
                            <MarkdownViewer content={mdContent} fontSize={fontSize} />
                            <div style={{display:'flex', justifyContent:'space-between', marginTop:40}}>
                                <button className="btn" style={{border:'1px solid', borderRadius:4}} 
                                    onClick={() => {
                                        const i = activeBook.chapters.findIndex(c=>c.id===activeChapter.id);
                                        if(i>0) loadChapter(activeBook, activeBook.chapters[i-1]);
                                    }}>Prev Chapter</button>
                                <button className="btn" style={{border:'1px solid', borderRadius:4}} 
                                    onClick={() => {
                                        const i = activeBook.chapters.findIndex(c=>c.id===activeChapter.id);
                                        if(i<activeBook.chapters.length-1) loadChapter(activeBook, activeBook.chapters[i+1]);
                                    }}>Next Chapter</button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            const HomeView = () => (
                <div className="scroll-reader-area">
                    <div className="book-sheet" style={{textAlign:'center', display:'flex', flexDirection:'column', justifyContent:'center'}}>
                        <h1 style={{color: 'var(--accent)'}}>GPT Library</h1>
                        <div style={{display:'grid', gridTemplateColumns:'repeat(auto-fit, minmax(200px,1fr))', gap:20, marginTop:40}}>
                            {books.map(b => (
                                <div key={b.id} style={{padding:20, border:'1px solid #ddd', borderRadius:8, cursor:'pointer'}}
                                     onClick={() => { setActiveBook(b); loadChapter(b, b.chapters[0]); setViewMode('read'); }}>
                                    <h3>{b.title}</h3>
                                    <p>{b.chapters.length} Chapters</p>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );

            // Utils
            const showToast = (msg) => { setToastMsg(msg); setTimeout(() => setToastMsg(''), 2000); };
            const cycleTheme = () => setTheme(t => t==='white'?'sepia':t==='sepia'?'black':'white');

            return (
                <div className="app-container">
                    <div className={`toast ${toastMsg ? 'show' : ''}`}>{toastMsg}</div>
                    {loading && <div className="loader">লোড হচ্ছে...</div>}

                    {viewMode === 'home' && <HomeView />}
                    
                    {viewMode === 'read' && (
                        readingSystem === 'scroll' ? <ScrollView /> : <FlipView />
                    )}

                    {/* Bottom Controls */}
                    <div className="controls no-print">
                        <button className="btn" onClick={() => { setViewMode('home'); setActiveBook(null); }}><span className="material-icons">home</span></button>
                        <div className="v-sep"></div>
                        
                        {viewMode === 'read' && (
                            <>
                                <button className={`btn ${readingSystem === 'scroll' ? 'active-mode' : ''}`} onClick={() => readingSystem !== 'scroll' && toggleReadingSystem()}>
                                    <span className="material-icons">article</span>
                                </button>
                                <button className={`btn ${readingSystem === 'flip' ? 'active-mode' : ''}`} onClick={() => readingSystem !== 'flip' && toggleReadingSystem()}>
                                    <span className="material-icons">auto_stories</span>
                                </button>
                                <div className="v-sep"></div>
                                <button className="btn" onClick={() => setFontSize(f => f - 2)}><span style={{fontSize:14, fontWeight:'bold'}}>A-</span></button>
                                <button className="btn" onClick={() => setFontSize(f => f + 2)}><span style={{fontSize:14, fontWeight:'bold'}}>A+</span></button>
                                <div className="v-sep"></div>
                            </>
                        )}
                        <button className="btn" onClick={cycleTheme}><span className="material-icons">{theme==='white'?'brightness_5':'dark_mode'}</span></button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
