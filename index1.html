<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPT Flipbook Library</title>
    <meta name="theme-color" id="theme-color" content="#4285f4" />

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">
    
    <!-- jQuery & Turn.js (‡¶´‡ßç‡¶≤‡¶ø‡¶™‡¶¨‡ßÅ‡¶ï‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

    <!-- React Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- KaTeX JS -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- ‡¶ó‡ßç‡¶≤‡ßã‡¶¨‡¶æ‡¶≤ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-body: #333; /* ‡¶∞‡¶ø‡¶°‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶°‡ßá ‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶≠‡¶æ‡¶≤‡ßã ‡¶≤‡¶æ‡¶ó‡ßá */
            --bg-paper: #fdf6e3;     
            --text-main: #1a1a1a;    
            --border-color: #000;    
            --accent: #d4af37;
            --highlight: #ffeeba;       
            --shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        /* ‡¶•‡¶ø‡¶Æ‡¶∏ */
        body.theme-white { --bg-paper: #ffffff; --text-main: #2c2c2c; }
        body.theme-sepia { --bg-paper: #fdf6e3; --text-main: #5b4636; }
        body.theme-black { --bg-paper: #1e1e1e; --text-main: #d1d1d1; }

        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Crimson Text', serif; background-color: var(--bg-body); }

        .app-container { display: flex; flex-direction: column; width: 100%; height: 100vh; }
        
        /* --- ‡¶´‡ßç‡¶≤‡¶ø‡¶™‡¶¨‡ßÅ‡¶ï ‡¶è‡¶∞‡¶ø‡ßü‡¶æ --- */
        .reader-area { 
            flex: 1; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            position: relative;
            overflow: hidden;
            perspective: 2000px;
        }

        #flipbook { transition: margin 0.3s; }

        .page {
            background-color: var(--bg-paper); color: var(--text-main);
            box-shadow: inset -5px 0 20px rgba(0,0,0,0.05);
            font-size: 18px; line-height: 1.6; text-align: justify;
            overflow: hidden;
            border-right: 1px solid rgba(0,0,0,0.1);
        }

        .page-content { 
            padding: 40px; 
            height: 100%; 
            display: flex; flex-direction: column; 
            /* ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶æ‡¶á ‡¶π‡¶¨‡ßá */
        }
        
        .page.hard {
            background: #4a192c !important; color: #d4af37 !important;
            border: 5px double #d4af37;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }

        /* --- ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶∏ --- */
        .controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: flex; gap: 12px; z-index: 1000;
            align-items: center; color: #333;
        }
        .btn { background: none; border: none; cursor: pointer; color: #333; display: flex; align-items: center; justify-content: center; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .btn:hover { background: rgba(0,0,0,0.1); }

        /* --- ‡¶π‡ßã‡¶Æ ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶ó‡ßç‡¶∞‡¶ø‡¶° --- */
        .home-view { width: 100%; height: 100%; overflow-y: auto; background: #eaddcf; padding: 40px 20px; text-align: center; }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; max-width: 1000px; margin: 0 auto; }
        .book-card {
            background: #4a192c; color: #d4af37; border-radius: 5px; cursor: pointer;
            height: 260px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); border-left: 10px solid #2c0e1a;
            transition: transform 0.3s;
        }
        .book-card:hover { transform: translateY(-10px); }

        /* --- ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏‡¶ø‡¶≠ --- */
        @media (max-width: 768px) {
            .page-content { padding: 20px; }
            .book-card { height: 200px; }
        }

        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; display: flex; justify-content: center; align-items: center; z-index: 3000; }
        
        /* KaTeX Fix */
        .katex { font-size: 1em; }
        img { max-width: 100%; height: auto; display: block; margin: 10px auto; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useLayoutEffect } = React;

        // --- FLIPBOOK COMPONENT ---
        const FlipbookReader = ({ content, title, fontSize, onPrev, onNext, theme }) => {
            const flipbookRef = useRef(null);
            const containerRef = useRef(null);
            const [pages, setPages] = useState([]);
            const [ready, setReady] = useState(false);

            // ‡ßß. ‡¶™‡ßá‡¶ú ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßç‡¶™‡ßç‡¶≤‡¶ø‡¶ü‡¶ø‡¶Ç (Pagination Logic)
            useEffect(() => {
                if (!content) return;

                const parser = new DOMParser();
                const htmlString = marked.parse(content);
                const doc = parser.parseFromString(htmlString, 'text/html');
                const elements = Array.from(doc.body.children);

                let newPages = [];
                let currentPage = "";
                
                // ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶∏‡¶æ‡¶á‡¶ú ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü
                const isMobile = window.innerWidth < 768;
                const charLimit = isMobile ? 500 : 900; 
                let currentCount = 0;

                // ‡¶è‡¶≤‡¶ø‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ß‡¶∞‡ßá ‡¶ß‡¶∞‡ßá ‡¶™‡ßá‡¶ú‡ßá ‡¶≠‡¶æ‡¶ó ‡¶ï‡¶∞‡¶æ
                elements.forEach(el => {
                    const elHTML = el.outerHTML;
                    const textLen = el.textContent.length;
                    
                    // ‡¶á‡¶Æ‡ßá‡¶ú ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Ö‡¶•‡¶¨‡¶æ ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶≤‡¶ø‡¶Æ‡¶ø‡¶ü ‡¶™‡¶æ‡¶∞ ‡¶π‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßá‡¶ú
                    if ((currentCount + textLen > charLimit) || el.tagName === 'IMG') {
                        if (currentPage) newPages.push(currentPage);
                        currentPage = "";
                        currentCount = 0;
                    }
                    currentPage += elHTML;
                    currentCount += textLen;
                });
                if (currentPage) newPages.push(currentPage);
                
                // ‡¶ï‡¶≠‡¶æ‡¶∞ ‡¶è‡¶¨‡¶Ç ‡¶∂‡ßá‡¶∑ ‡¶™‡ßá‡¶ú ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ
                setPages([
                    { type: 'cover', content: title },
                    ...newPages.map(c => ({ type: 'content', content: c })),
                    { type: 'end', content: 'THE END' }
                ]);
                setReady(false); // Turn.js ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
            }, [content, title]);

            // ‡ß®. Turn.js ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶®
            useEffect(() => {
                if (pages.length === 0 || !flipbookRef.current) return;

                const $el = $(flipbookRef.current);
                
                // ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶á‡¶®‡ßç‡¶∏‡¶ü‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶ß‡ßç‡¶¨‡¶Ç‡¶∏ ‡¶ï‡¶∞‡¶æ
                try { if ($el.data().turn) $el.turn('destroy'); } catch(e){}

                // ‡¶∏‡¶æ‡¶á‡¶ú ‡¶ï‡ßç‡¶Ø‡¶æ‡¶≤‡¶ï‡ßÅ‡¶≤‡ßá‡¶∂‡¶®
                const w = window.innerWidth;
                const h = window.innerHeight;
                const isMobile = w < 768;
                let bookH = h * 0.85;
                let bookW = isMobile ? (w * 0.95) : (bookH * 1.4);
                if (!isMobile && bookW > w * 0.9) bookW = w * 0.9;

                // Turn.js ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ (‡¶è‡¶ï‡¶ü‡ßÅ ‡¶°‡¶ø‡¶≤‡ßá ‡¶¶‡¶ø‡ßü‡ßá DOM ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶™‡¶∞)
                setTimeout(() => {
                    $el.turn({
                        width: bookW,
                        height: bookH,
                        autoCenter: true,
                        display: isMobile ? 'single' : 'double',
                        duration: 1000,
                        gradients: true,
                        elevation: 50
                    });

                    // ‡¶ï‡¶ø‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü
                    $(window).unbind('keydown').bind('keydown', function(e) {
                        if (e.keyCode == 37) $el.turn('previous');
                        if (e.keyCode == 39) $el.turn('next');
                    });
                    
                    // MathJax/KaTeX ‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞
                    if(window.renderMathInElement) {
                        window.renderMathInElement(flipbookRef.current, {
                            delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]
                        });
                    }

                    setReady(true);
                }, 100);

                // ‡¶ï‡ßç‡¶≤‡¶ø‡¶®‡¶Ü‡¶™
                return () => {
                    try { if ($el.data().turn) $el.turn('destroy'); } catch(e){}
                };
            }, [pages]); // ‡¶™‡ßá‡¶ú ‡¶ö‡ßá‡¶û‡ßç‡¶ú ‡¶π‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∞‡¶æ‡¶® ‡¶π‡¶¨‡ßá

            // ‡¶´‡¶®‡ßç‡¶ü ‡¶∏‡¶æ‡¶á‡¶ú ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∞‡¶ø-‡¶∞‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶è‡ßú‡¶æ‡¶®‡ßã, ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø DOM ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶û‡ßç‡¶ú
            useEffect(() => {
                if(flipbookRef.current) {
                    const contentDivs = flipbookRef.current.querySelectorAll('.page-content');
                    contentDivs.forEach(div => div.style.fontSize = `${fontSize}px`);
                }
            }, [fontSize]);

            return (
                <div id="flipbook" ref={flipbookRef} style={{opacity: ready ? 1 : 0}}>
                    {pages.map((page, idx) => {
                        if (page.type === 'cover') {
                            return (
                                <div key={idx} className="page hard">
                                    <h1 style={{fontSize:'2rem'}}>{page.content}</h1>
                                    <p>Tap to open</p>
                                </div>
                            );
                        } else if (page.type === 'end') {
                            return <div key={idx} className="page hard"><h3>{page.content}</h3></div>;
                        } else {
                            return (
                                <div key={idx} className="page">
                                    <div className="page-content" style={{fontSize: `${fontSize}px`}} dangerouslySetInnerHTML={{__html: page.content}}></div>
                                </div>
                            );
                        }
                    })}
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        function App() {
            const [books, setBooks] = useState([]);
            const [activeBook, setActiveBook] = useState(null);
            const [activeChapter, setActiveChapter] = useState(null);
            const [mdContent, setMdContent] = useState('');
            const [viewMode, setViewMode] = useState('home'); // home, read
            const [theme, setTheme] = useState('white'); 
            const [fontSize, setFontSize] = useState(18);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                fetch('books/db.json')
                    .then(res => res.json())
                    .then(data => setBooks(data))
                    .catch(() => {
                        // ‡¶´‡¶≤‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶°‡¶æ‡¶ü‡¶æ
                        setBooks([
                            { id: "1", title: "Demo Book", chapters: [{id:"c1", file: "sample.md", title: "Chapter 1"}] }
                        ]);
                    });
            }, []);

            // ‡¶•‡¶ø‡¶Æ ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
            useEffect(() => {
                document.body.className = `theme-${theme}`;
            }, [theme]);

            const loadChapter = (book, chapter) => {
                setLoading(true);
                // ‡¶¨‡¶æ‡¶∏‡ßç‡¶§‡¶¨‡ßá fetch ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨‡ßá‡¶®, ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
                const path = book.folder ? `${book.folder}/${chapter.file}` : chapter.file;
                
                fetch(path).then(res => {
                    if(!res.ok) throw new Error("File missing");
                    return res.text();
                })
                .then(text => {
                    setMdContent(text);
                    setActiveBook(book);
                    setActiveChapter(chapter);
                    setViewMode('read');
                    setLoading(false);
                })
                .catch(err => {
                    // ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶°‡ßá‡¶Æ‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶Ø‡¶æ‡ßü
                    let dummy = `# ${chapter.title}\n\n`;
                    for(let i=0; i<20; i++) dummy += `‡¶Ö‡¶®‡ßÅ‡¶ö‡ßç‡¶õ‡ßá‡¶¶ ${i+1}: ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶°‡¶æ‡¶Æ‡¶ø ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü‡•§ Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.\n\n`;
                    setMdContent(dummy);
                    setActiveBook(book);
                    setActiveChapter(chapter);
                    setViewMode('read');
                    setLoading(false);
                });
            };

            const goHome = () => {
                setViewMode('home');
                setMdContent('');
            };

            const cycleTheme = () => setTheme(t => t==='white'?'sepia':t==='sepia'?'black':'white');
            
            // ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶∂‡¶® (Next/Prev Chapter)
            const nextChapter = () => {
                if(!activeBook || !activeChapter) return;
                const idx = activeBook.chapters.findIndex(c => c.id === activeChapter.id);
                if(idx < activeBook.chapters.length - 1) loadChapter(activeBook, activeBook.chapters[idx+1]);
            };

            const prevChapter = () => {
                if(!activeBook || !activeChapter) return;
                const idx = activeBook.chapters.findIndex(c => c.id === activeChapter.id);
                if(idx > 0) loadChapter(activeBook, activeBook.chapters[idx-1]);
            };

            return (
                <div className="app-container">
                    {loading && <div className="loader">‡¶¨‡¶á ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>}

                    {/* ‡ßß. ‡¶π‡ßã‡¶Æ ‡¶≠‡¶ø‡¶â */}
                    {viewMode === 'home' && (
                        <div className="home-view">
                            <div style={{fontSize:'2.5rem', color:'#4a192c', fontWeight:'bold', marginBottom:'30px'}}>MY LIBRARY</div>
                            <div className="book-grid">
                                {books.map(b => (
                                    <div key={b.id} className="book-card" onClick={() => loadChapter(b, b.chapters[0])}>
                                        <div style={{fontSize:'1.5rem', fontWeight:'bold', marginBottom:'10px'}}>{b.title}</div>
                                        <div style={{opacity:0.8}}>{b.chapters.length} Chapters</div>
                                        <div style={{marginTop:'auto', fontSize:'2rem'}}>üìñ</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {/* ‡ß®. ‡¶∞‡¶ø‡¶°‡¶æ‡¶∞ ‡¶≠‡¶ø‡¶â (‡¶´‡ßç‡¶≤‡¶ø‡¶™‡¶¨‡ßÅ‡¶ï) */}
                    {viewMode === 'read' && (
                        <div className="reader-area">
                            <FlipbookReader 
                                content={mdContent} 
                                title={activeChapter ? activeChapter.title : ''}
                                fontSize={fontSize}
                                theme={theme}
                            />
                            
                            {/* ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤‡¶∏ */}
                            <div className="controls">
                                <button className="btn" onClick={goHome} title="Home"><span className="material-icons">home</span></button>
                                <div style={{width:'1px', height:'20px', background:'#ccc'}}></div>
                                
                                <button className="btn" onClick={prevChapter} title="Previous Chapter"><span className="material-icons">skip_previous</span></button>
                                <button className="btn" onClick={() => $('#flipbook').turn('previous')}><span className="material-icons">west</span></button>
                                <button className="btn" onClick={() => $('#flipbook').turn('next')}><span className="material-icons">east</span></button>
                                <button className="btn" onClick={nextChapter} title="Next Chapter"><span className="material-icons">skip_next</span></button>
                                
                                <div style={{width:'1px', height:'20px', background:'#ccc'}}></div>
                                <button className="btn" onClick={() => setFontSize(s => Math.max(14, s-2))}>A-</button>
                                <button className="btn" onClick={() => setFontSize(s => Math.min(32, s+2))}>A+</button>
                                <div style={{width:'1px', height:'20px', background:'#ccc'}}></div>
                                <button className="btn" onClick={cycleTheme} title="Theme"><span className="material-icons">brightness_6</span></button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
