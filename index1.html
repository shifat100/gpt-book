<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPT E-Book Fullscreen</title>
    <meta name="theme-color" id="theme-color" content="#2d2d2d" />

    <!-- KaTeX CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css">
    
    <!-- React Libraries -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/contrib/auto-render.min.js"></script>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
        /* --- গ্লোবাল স্টাইল --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        :root {
            --bg-body: #e0e0e0;      
            --bg-paper: #ffffff;     
            --text-main: #1a1a1a;    
            --border-color: #000;    
            --accent: #8b0000;
            --flip-bg: #2d2d2d; /* ফ্লিপ মোডে ব্যাকগ্রাউন্ড ডার্ক হবে */
            
            /* Flipbook Dynamic Size (Responsive to Screen) */
            --book-height: 85vh; 
            --book-width: 58vh; /* 85vh height এর অনুপাতে width */
            --flip-speed: 0.6s;
        }

        /* Mobile Size Override */
        @media (max-width: 768px) {
            :root {
                --book-width: 90vw;
                --book-height: 125vw; /* মোবাইলের জন্য লম্বাটে */
            }
        }

        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: 'Crimson Text', serif; }

        .app-container { display: flex; flex-direction: column; width: 100%; height: 100%; }
        
        /* Reader Area styles switch based on mode */
        .reader-area { flex: 1; overflow-y: auto; padding: 20px; display: flex; justify-content: center; position: relative; transition: background 0.3s; }
        .reader-area.flip-mode { 
            padding: 0; 
            overflow: hidden; 
            background-color: var(--flip-bg); 
            align-items: center; /* Center Vertically */
        }

        /* --- SCROLL VIEW STYLES --- */
        .book-sheet {
            background-color: var(--bg-paper); color: var(--text-main);
            width: 100%; max-width: 800px; min-height: 100%; height: fit-content;
            padding: 60px 50px; padding-bottom: 100px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15); border-radius: 4px;
        }

        /* --- FLIPBOOK 3D ENGINE --- */
        .scene {
            position: relative;
            width: calc(var(--book-width) * 2); 
            height: var(--book-height);
            perspective: 2500px;
            display: flex; justify-content: center; align-items: center;
        }
        
        .book-3d {
            position: relative; width: 100%; height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .paper-3d {
            position: absolute; width: var(--book-width); height: 100%;
            top: 0; left: var(--book-width); /* Default: Right Side */
            transform-origin: left;
            transition: transform var(--flip-speed) cubic-bezier(0.645, 0.045, 0.355, 1);
            transform-style: preserve-3d;
            cursor: pointer;
            border-radius: 0 5px 5px 0;
        }
        
        .paper-content {
            position: absolute; width: 100%; height: 100%; top: 0; left: 0;
            background-color: #fff;
            color: #222; /* Always dark text on paper */
            backface-visibility: hidden;
            padding: 40px 30px;
            overflow: hidden;
            border: 1px solid #ccc;
            display: flex; flex-direction: column;
        }
        
        .paper-content.front { z-index: 2; border-radius: 0 5px 5px 0; }
        /* Realistic Shadow on Fold */
        .paper-content.front::after {
            content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 20px;
            background: linear-gradient(to right, rgba(0,0,0,0), rgba(0,0,0,0.05)); pointer-events: none;
        }
        .paper-content.back {
            z-index: 1; transform: rotateY(180deg);
            border-left: none; border-right: 1px solid #ccc;
            border-radius: 5px 0 0 5px;
            background-color: #fdfdfd;
        }
        .paper-content.back::after {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 20px;
            background: linear-gradient(to left, rgba(0,0,0,0), rgba(0,0,0,0.05)); pointer-events: none;
        }

        .paper-3d.flipped { transform: rotateY(-180deg); }

        /* Mobile View - Single Page Logic */
        @media (max-width: 768px) {
            .scene { width: 100%; perspective: 1500px; }
            .paper-3d { left: 50%; transform: translateX(-50%); border-radius: 5px; }
            .paper-content.front { border-radius: 5px; }
            .paper-content.back { border-radius: 5px; }
            .book-3d { transform: none !important; } /* Disable shifting on mobile */
            
            /* In mobile, flipped page should hide or move away properly */
            .paper-3d.flipped { transform: translateX(-50%) rotateY(-180deg); pointer-events: none; opacity: 0; }
            
            /* Text adjustments for small screens */
            .paper-content { padding: 30px 20px; }
        }

        .page-number { position: absolute; bottom: 15px; width: 100%; text-align: center; font-size: 12px; opacity: 0.6; left:0; }
        
        /* Markdown Adjustments for Fixed Page */
        .markdown-body { font-size: 16px; line-height: 1.6; text-align: justify; }
        .markdown-body h1 { font-size: 1.8em; text-align: center; margin-bottom: 20px; color: #8b0000; }
        .markdown-body h2 { font-size: 1.4em; margin-top: 15px; border-bottom: 1px solid #eee; }
        .markdown-body p { margin-bottom: 15px; }
        .markdown-body img { max-width: 100%; max-height: 40vh; object-fit: contain; margin: 10px auto; display: block; }

        /* Controls UI */
        .controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255,255,255,0.9); padding: 8px 20px; border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; gap: 12px; z-index: 5000;
            border: 1px solid #ccc; backdrop-filter: blur(5px);
        }
        .btn { background: none; border: none; cursor: pointer; color: #333; display: flex; align-items: center; justify-content: center; padding: 8px; border-radius: 50%; transition: 0.2s; min-width: 44px; min-height: 44px; }
        .btn:hover { background: rgba(0,0,0,0.1); }
        .btn.active-mode { background: #333; color: #fff; }
        
        .v-sep { width: 1px; height: 24px; background: #999; opacity: 0.3; flex-shrink: 0; }
        
        .loader { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: white; padding: 15px 30px; border-radius: 30px; z-index: 3000; }
        
        /* Modal & Lists */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .book-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; padding: 10px; width: 100%; max-width: 800px; }
        .book-card { background: #fff; padding: 20px; border-radius: 8px; cursor: pointer; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* Print Hide */
        @media print { .controls, .no-print { display: none; } .reader-area { background: white; } }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- UTILS: Pagination Logic ---
        // Splits content into chunks that fit on the page
        const splitContentIntoPages = (text, charsPerPage) => {
            if (!text) return [];
            // Basic approximation logic
            const paragraphs = text.split('\n');
            const pages = [];
            let currentPage = "";
            let charCount = 0;

            paragraphs.forEach(p => {
                const pLen = p.length;
                if (charCount + pLen > charsPerPage && charCount > 100) {
                    pages.push(currentPage);
                    currentPage = p + '\n';
                    charCount = pLen;
                } else {
                    currentPage += p + '\n';
                    charCount += pLen;
                }
            });
            if (currentPage) pages.push(currentPage);
            return pages;
        };

        // --- COMPONENT: Markdown Viewer ---
        const MarkdownViewer = ({ content, fontSize }) => {
            const rootRef = useRef();
            const html = useMemo(() => marked.parse(content || ''), [content]);

            useEffect(() => {
                if (rootRef.current && window.renderMathInElement) {
                    window.renderMathInElement(rootRef.current, {
                        delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}],
                        throwOnError: false
                    });
                }
            }, [html]);

            return <div ref={rootRef} className="markdown-body" style={{fontSize: fontSize + 'px'}} dangerouslySetInnerHTML={{ __html: html }} />;
        };

        // --- COMPONENT: FlipBook Viewer (UPDATED) ---
        const FlipBookViewer = ({ content, chapterTitle, fontSize, onPrevChap, onNextChap, isFirstChap, isLastChap }) => {
            // Determine char limit based on screen size (approximate)
            const isMobile = window.innerWidth < 768;
            const charLimit = isMobile ? 800 : 1300; 

            const pagesContent = useMemo(() => splitContentIntoPages(content, charLimit), [content, charLimit]);
            
            // Group into papers (Front + Back)
            const papers = useMemo(() => {
                let p = [];
                // Add a Title Page for the chapter if it's the start
                let contentArray = [...pagesContent];
                
                // Grouping
                for(let i=0; i < contentArray.length; i+=2) {
                    p.push({
                        front: contentArray[i],
                        back: contentArray[i+1] || null // null means end of chapter on front page
                    });
                }
                return p;
            }, [pagesContent]);

            const [currentLocation, setCurrentLocation] = useState(1);
            const totalPapers = papers.length;

            // Reset when content (chapter) changes
            useEffect(() => {
                setCurrentLocation(1);
            }, [content]);

            const goNext = () => {
                if (currentLocation <= totalPapers) {
                    setCurrentLocation(prev => prev + 1);
                } else {
                    // We are at the end of this chapter
                    if (!isLastChap && onNextChap) {
                        onNextChap(); // Load next chapter seamlessly
                    }
                }
            };

            const goPrev = () => {
                if (currentLocation > 1) {
                    setCurrentLocation(prev => prev - 1);
                } else {
                    // Start of chapter
                    if (!isFirstChap && onPrevChap) {
                        onPrevChap(); // Go to previous chapter end (logic handled in parent)
                    }
                }
            };

            // Keyboard navigation
            useEffect(() => {
                const handleKey = (e) => {
                    if(e.key === 'ArrowRight') goNext();
                    if(e.key === 'ArrowLeft') goPrev();
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [currentLocation, totalPapers]);

            // Calculate Book Shift (For PC: Center spread when open)
            const bookTransform = (!isMobile && currentLocation > 1 && currentLocation <= totalPapers) 
                ? 'translateX(50%)' 
                : 'translateX(0%)';

            return (
                <div className="scene">
                    <div className="book-3d" style={{ transform: isMobile ? 'none' : bookTransform }}>
                        {/* Cover / Title of Chapter */}
                        <div className={`paper-3d ${currentLocation > 0 ? 'flipped' : ''}`} style={{zIndex: totalPapers + 2, display:'none'}}></div> 

                        {papers.map((paper, index) => {
                            const paperNum = index + 1;
                            const isFlipped = currentLocation > paperNum;
                            // Z-Index Stack Logic
                            let zIndex = isFlipped ? paperNum : (totalPapers - index + 1);
                            
                            return (
                                <div 
                                    key={index}
                                    className={`paper-3d ${isFlipped ? 'flipped' : ''}`}
                                    style={{ zIndex: zIndex }}
                                    onClick={() => isFlipped ? goPrev() : goNext()}
                                >
                                    {/* Front Side */}
                                    <div className="paper-content front">
                                        {index === 0 && <h3 style={{textAlign:'center', color:'#8b0000', marginBottom:'10px', textTransform:'uppercase'}}>{chapterTitle}</h3>}
                                        <MarkdownViewer content={paper.front} fontSize={fontSize} />
                                        <div className="page-number">{(index * 2) + 1}</div>
                                    </div>
                                    
                                    {/* Back Side */}
                                    <div className="paper-content back">
                                        {paper.back ? (
                                            <>
                                                <MarkdownViewer content={paper.back} fontSize={fontSize} />
                                                <div className="page-number">{(index * 2) + 2}</div>
                                            </>
                                        ) : (
                                            <div style={{display:'flex', height:'100%', justifyContent:'center', alignItems:'center', flexDirection:'column', opacity:0.5}}>
                                                <span className="material-icons" style={{fontSize:'40px'}}>auto_stories</span>
                                                <p>Chapter End</p>
                                                {!isLastChap && <small>Tap to continue...</small>}
                                            </div>
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    {/* Invisible Touch Zones for Mobile Easy Nav */}
                    {isMobile && <div style={{position:'absolute', left:0, top:0, width:'20%', height:'100%', zIndex:200}} onClick={(e)=>{e.stopPropagation(); goPrev();}}></div>}
                    {isMobile && <div style={{position:'absolute', right:0, top:0, width:'20%', height:'100%', zIndex:200}} onClick={(e)=>{e.stopPropagation(); goNext();}}></div>}
                </div>
            );
        };

        // --- MAIN APP ---
        function App() {
            const [books, setBooks] = useState([]);
            const [activeBook, setActiveBook] = useState(null);
            const [activeChapter, setActiveChapter] = useState(null);
            const [mdContent, setMdContent] = useState('');
            const [viewMode, setViewMode] = useState('home'); // home, index, read
            const [readingMode, setReadingMode] = useState('flip'); // 'scroll' or 'flip'
            const [loading, setLoading] = useState(false);
            const [fontSize, setFontSize] = useState(16);

            // Fake Data Loader (Replace with fetch('books/db.json') in production)
            useEffect(() => {
                // Demo Data for testing
                const demoBooks = [{
                    id: "b1", title: "Physics Demo", folder: "", 
                    chapters: [
                        {id: "c1", title: "Introduction", file: "intro.md", content: "# Introduction\nWelcome to Physics.\n\nPhysics is the natural science that studies matter, its fundamental constituents, its motion and behavior through space and time, and the related entities of energy and force."},
                        {id: "c2", title: "Newton's Laws", file: "newton.md", content: "# Newton's Laws\n\n## First Law\nIn an inertial frame of reference, an object either remains at rest or continues to move at a constant velocity, unless acted upon by a force.\n\n## Second Law\n$$F = ma$$\nThe vector sum of the forces F on an object is equal to the mass m of that object multiplied by the acceleration a of the object."},
                        {id: "c3", title: "Conclusion", file: "end.md", content: "# Conclusion\nThis is the end of the demo book.\n\nThank you for reading."}
                    ]
                }];
                setBooks(demoBooks);
            }, []);

            const loadChapter = (book, chapter) => {
                setActiveBook(book);
                setActiveChapter(chapter);
                setLoading(true);
                
                // Simulate network request (or use real fetch)
                setTimeout(() => {
                    // For demo, we use content inside object. For real app, use fetch().
                    const text = chapter.content || "# No Content"; 
                    setMdContent(text);
                    setViewMode('read');
                    setLoading(false);
                }, 300);
            };

            const navigateChapter = (direction) => {
                if (!activeBook || !activeChapter) return;
                const idx = activeBook.chapters.findIndex(c => c.id === activeChapter.id);
                
                if (direction === 'next') {
                    if (idx < activeBook.chapters.length - 1) {
                        loadChapter(activeBook, activeBook.chapters[idx + 1]);
                    }
                } else if (direction === 'prev') {
                    if (idx > 0) {
                        loadChapter(activeBook, activeBook.chapters[idx - 1]);
                    }
                }
            };

            const isFirstChap = activeBook && activeChapter && activeBook.chapters[0].id === activeChapter.id;
            const isLastChap = activeBook && activeChapter && activeBook.chapters[activeBook.chapters.length - 1].id === activeChapter.id;

            return (
                <div className="app-container">
                    {loading && <div className="loader">লোড হচ্ছে...</div>}

                    {/* --- HOME VIEW --- */}
                    {viewMode === 'home' && (
                        <div className="reader-area">
                            <div className="book-sheet" style={{textAlign:'center', display:'flex', flexDirection:'column', justifyContent:'center', minHeight:'60vh'}}>
                                <h1 style={{color:'var(--accent)'}}>LIBRARY</h1>
                                <div className="book-grid" style={{margin:'0 auto'}}>
                                    {books.map(b => (
                                        <div key={b.id} className="book-card" onClick={() => {setActiveBook(b); setViewMode('index');}}>
                                            <h3>{b.title}</h3>
                                            <p>{b.chapters.length} Chapters</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- INDEX VIEW --- */}
                    {viewMode === 'index' && activeBook && (
                        <div className="reader-area">
                            <div className="book-sheet">
                                <h2 style={{textAlign:'center'}}>{activeBook.title}</h2>
                                <hr/>
                                {activeBook.chapters.map(c => (
                                    <div key={c.id} onClick={() => loadChapter(activeBook, c)} style={{padding:'15px', borderBottom:'1px dashed #ccc', cursor:'pointer', display:'flex', justifyContent:'space-between'}}>
                                        <span>{c.title}</span> <span className="material-icons">chevron_right</span>
                                    </div>
                                ))}
                                <button onClick={() => setViewMode('home')} style={{marginTop:'20px', padding:'10px'}}>Back to Home</button>
                            </div>
                        </div>
                    )}

                    {/* --- READING VIEW --- */}
                    {viewMode === 'read' && (
                        <div className={`reader-area ${readingMode === 'flip' ? 'flip-mode' : ''}`}>
                            {readingMode === 'scroll' ? (
                                // SCROLL MODE
                                <div className="book-sheet">
                                    <div style={{opacity:0.5, textAlign:'center', fontSize:'0.8em', marginBottom:'20px'}}>{activeChapter.title}</div>
                                    <MarkdownViewer content={mdContent} fontSize={fontSize} />
                                    <div style={{display:'flex', justifyContent:'space-between', marginTop:'50px'}}>
                                        <button disabled={isFirstChap} onClick={() => navigateChapter('prev')}>Previous</button>
                                        <button disabled={isLastChap} onClick={() => navigateChapter('next')}>Next</button>
                                    </div>
                                </div>
                            ) : (
                                // FLIP MODE (Fullscreen & Centered)
                                <FlipBookViewer 
                                    content={mdContent}
                                    chapterTitle={activeChapter.title}
                                    fontSize={fontSize}
                                    onPrevChap={() => navigateChapter('prev')}
                                    onNextChap={() => navigateChapter('next')}
                                    isFirstChap={isFirstChap}
                                    isLastChap={isLastChap}
                                />
                            )}
                        </div>
                    )}

                    {/* --- CONTROLS --- */}
                    <div className="controls">
                        <button className="btn" onClick={() => setViewMode('home')}><span className="material-icons">home</span></button>
                        {viewMode === 'read' && (
                            <>
                                <div className="v-sep"></div>
                                <button className="btn" onClick={() => setViewMode('index')}><span className="material-icons">list</span></button>
                                <button className={`btn ${readingMode === 'flip' ? 'active-mode' : ''}`} onClick={() => setReadingMode(m => m === 'scroll' ? 'flip' : 'scroll')}>
                                    <span className="material-icons">{readingMode === 'scroll' ? 'vertical_split' : 'auto_stories'}</span>
                                </button>
                                <div className="v-sep"></div>
                                <button className="btn" onClick={() => setFontSize(f => f-2)}><span className="material-icons">remove</span></button>
                                <button className="btn" onClick={() => setFontSize(f => f+2)}><span className="material-icons">add</span></button>
                            </>
                        )}
                    </div>

                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
